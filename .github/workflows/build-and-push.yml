name: Build and Push Koha Image

# –ö–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Ü–µ–π –ø–∞–π–ø–ª–∞–π–Ω
on:
  push:
    branches:
      - main # –ó–∞–ø—É—Å–∫–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø—É—à—ñ –≤ –≥—ñ–ª–∫—É main
    paths-ignore:
      - 'README.md' # –ù–µ –∑–±–∏—Ä–∞—Ç–∏ –æ–±—Ä–∞–∑, —è–∫—â–æ –º–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–ø—Ä–∞–≤–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é
      - 'docs/**'
  workflow_dispatch: # –î–æ–∑–≤–æ–ª—è—î –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä–∫—É –≤—Ä—É—á–Ω—É –∫–Ω–æ–ø–∫–æ—é –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É GitHub

# –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø—Ä–∞–≤–∞ –¥–ª—è —Ü—å–æ–≥–æ workflow
permissions:
  contents: read

# –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –ø—É—à—ñ–≤ –æ–¥–Ω–æ–≥–æ –π —Ç–æ–≥–æ –∂ workflow
concurrency:
  group: koha-image-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: pinokew/koha
  KOHA_VERSION: "25.05"

jobs:
  # ==========================================
  # –ù–û–í–ò–ô –ë–õ–û–ö: 1. CI-Checks (Pre-build Security & Linting)
  # ==========================================
  ci-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üêö Run Shellcheck (Script Validation)
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Å—ñ bash-—Å–∫—Ä–∏–ø—Ç–∏ —É –ø–∞–ø—Ü—ñ scripts. –ü–æ–∫–∏ —â–æ –Ω–µ –±–ª–æ–∫—É—î–º–æ –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–∏ warnings (|| true).
          find scripts -type f -name "*.sh" -print0 | xargs -0 shellcheck -e SC1090,SC1091,SC2034,SC2046,SC2086,SC2155 || echo "Shellcheck warnings found, please review."

      - name: üõ°Ô∏è Trivy Config Scan (Critical gate for IaC & Secrets)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1' # –ë–ª–æ–∫—É—î –∑–±—ñ—Ä–∫—É, —è–∫—â–æ –≤ Dockerfile –∞–±–æ –∫–æ–¥—ñ —î –∫—Ä–∏—Ç–∏—á–Ω—ñ –¥—ñ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∂–µ–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏ –∞–±–æ –∑–∞–ø—É—Å–∫ –≤—ñ–¥ root)

  # ==========================================
  # 2. Build & Push (–ü–æ—Ç–æ—á–Ω–∏–π –±–ª–æ–∫, —â–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ CI)
  # ==========================================
  build:
    needs: ci-checks # –ù–û–í–ò–ô –ë–õ–û–ö: –ó–±—ñ—Ä–∫–∞ –ø–æ—á–Ω–µ—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò —è–∫—â–æ –∫–æ–¥ –ø—Ä–æ–π—à–æ–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É ci-checks
    runs-on: ubuntu-latest

    steps:
      # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      - name: Checkout repository
        uses: actions/checkout@v6

      # 2. –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è –∑–±—ñ—Ä–∫–∏ Docker (–¥–æ–¥–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫—É –±–∞–≥–∞—Ç–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—ñ —Ç–∞ –∫–µ—à—É)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. –õ–æ–≥—ñ–Ω–∏–º–æ—Å—è –≤ Docker Hub, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –Ω–∞—à—ñ —Å–µ–∫—Ä–µ—Ç–∏
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. –ó–±–∏—Ä–∞—î–º–æ –æ–±—Ä–∞–∑ —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –π–æ–≥–æ (Push)
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            KOHA_VERSION=${{ env.KOHA_VERSION }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.KOHA_VERSION }}
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–µ—à GitHub Actions, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–±—ñ—Ä–∫–∏ –±—É–ª–∏ —É 2-3 —Ä–∞–∑–∏ —à–≤–∏–¥—à–∏–º–∏
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–ø–∏—Å—É –Ω–∞ Docker Hub
      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.IMAGE_NAME }} 
          readme-filepath: ./README.md

      # ==========================================
      # –ù–û–í–ò–ô –ë–õ–û–ö: 6. Trivy Image Scan (Post-build Security)
      # ==========================================
      - name: üõ°Ô∏è Trivy Image Scan (Critical gate for CVEs)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:sha-${{ github.sha }} # –°–∫–∞–Ω—É—î–º–æ —â–æ–π–Ω–æ –∑—ñ–±—Ä–∞–Ω–∏–π –æ–±—Ä–∞–∑ –∑–∞ –π–æ–≥–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º SHA
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1' # –§–µ–π–ª–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω, —è–∫—â–æ –≤ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞–∫–µ—Ç–∞—Ö —î CRITICAL –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ
          ignore-unfixed: true # –Ü–≥–Ω–æ—Ä—É—î –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ, –¥–ª—è —è–∫–∏—Ö —â–µ –Ω–µ–º–∞—î –ø–∞—Ç—á–∞ –≤—ñ–¥ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ Debian/Ubuntu